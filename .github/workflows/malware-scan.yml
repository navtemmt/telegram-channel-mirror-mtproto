name: Malware Scan

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    name: Scan for malware and suspicious code
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run virus scan
        uses: crazy-max/ghaction-virustotal@v4
        with:
          vt_api_key: ${{ secrets.VT_API_KEY }}
          files: |
            ./**/*
          request_rate: 4
        continue-on-error: true
      
      - name: Scan with ClamAV
        run: |
          sudo apt-get update
          sudo apt-get install -y clamav clamav-daemon
          sudo freshclam
          clamscan -r --bell -i . || true
      
      - name: Check for suspicious patterns
        run: |
          echo "Scanning for suspicious patterns..."
          # Check for obfuscated code
          grep -r "eval(" . --exclude-dir=node_modules --exclude-dir=.git || true
          grep -r "Function(" . --exclude-dir=node_modules --exclude-dir=.git || true
          # Check for suspicious network calls
          grep -r "http://" . --exclude-dir=node_modules --exclude-dir=.git || true
          echo "Pattern scan complete"
